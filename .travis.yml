language: c

services:
  - docker

before_install:
  - sudo apt-get update

install:
  - sudo apt-get install -qq raptor2-utils

before_script:
  - docker build -t atomgraph/processor .
  - pushd .
  - cd http-tests
  - docker-compose up -d # run fuseki and processor containers in the background
  - while ! curl -w "%{http_code}\n" -s -o /dev/null http://localhost:8080 | grep "404" ; do sleep 1 ; done # wait for processor-ct to start
  - while ! curl -w "%{http_code}\n" -s -o /dev/null http://localhost:8081 | grep "404" ; do sleep 1 ; done # wait for processor-ct-write to start
  - while ! curl -w "%{http_code}\n" -s -o /dev/null http://localhost:8082 | grep "404" ; do sleep 1 ; done # wait for processor-ngt to start
  - while ! curl -w "%{http_code}\n" -s -o /dev/null http://localhost:8083 | grep "404" ; do sleep 1 ; done # wait for processor-ngt-write to start
  - while ! curl -w "%{http_code}\n" -s -o /dev/null http://localhost:8084 | grep "500" ; do sleep 1 ; done # wait for processor-custom to start
  - while ! curl -w "%{http_code}\n" -s -o /dev/null http://localhost:8085 | grep "500" ; do sleep 1 ; done # wait for processor-custom-write to start

script:
  - bash ./run.sh # run tests

after_script:
  - popd
  - docker-compose down # shutdown fuseki and processor
  - docker-compose rm -f

notifications:
  email:
    recipients:
      - martynas@atomgraph.com